{"version":3,"sources":["manage_courses.js"],"names":["define","$","ajax","Notification","ModalFactory","ModalSaveCancel","ModalEvents","ManageCoursesView","ManageCoursesFilters","SELECTORS","PROMISES","courseid","call","methodname","args","search","length","start","order","studentid","messagetext","on","event","preventDefault","_this","this","trigger","create","title","attr","done","modal","addClass","getRoot","hidden","destroy","setBody","data","response","find","ctx","getContext","Chart","type","labels","M","util","get_string","datasets","backgroundColor","studentcompletedcolor","inprogresscolor","yettostartcolor","options","legend","display","fail","exception","setTimeout","show","is","DataTable","bPaginate","bServerSide","language","searchPlaceholder","emptyTable","dom","initComplete","settings","json","append","callback","value","columns","className","rowCallback","row","index","val","file","encodeURIComponent","filedata","filename","hide","click","remove","types","SAVE_CANCEL","setSaveButtonText","parent","siblings","html","save","message","ex","init","root","document","ready"],"mappings":"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","sourcesContent":["define([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/modal_factory',\n    'core/modal_save_cancel',\n    'core/modal_events',\n    'block_remuiblck/manage_courses_view',\n    'block_remuiblck/manage_courses_filters',\n    'core/chartjs',\n    'block_remuiblck/jquery.dataTables',\n    'block_remuiblck/dataTables.bootstrap4'\n], function(\n    $,\n    ajax,\n    Notification,\n    ModalFactory,\n    ModalSaveCancel,\n    ModalEvents,\n    ManageCoursesView,\n    ManageCoursesFilters\n) {\n\n    var SELECTORS = {\n        VIEW_REPORT: '.remui-view-course-report',\n        STATS_TAB: '#wdm-userstats',\n        STATS_TABLE: '#userstats-table',\n        EXPORT_WRAPPER: '#userstats-table_wrapper .wdm-export-buttons',\n        EXPORT: '.wdm-manage-course-export-csv',\n        STATS_CHART: '#coursestats-chart',\n        STATS_FILTER_INPUT: '#userstats-table_filter input',\n        DROPPING_STUDENT_MESSAGE: '.dropping-student-message'\n    };\n\n    var PROMISES = {\n        /**\n         * Get course report promise\n         * @param  {int}    courseid Course id\n         * @return promise           Ajax promise object\n         */\n        GET_COURSE_REPORT: function(courseid) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_get_course_report',\n                args: {\n                    courseid: courseid\n                }\n            }])[0];\n        },\n\n        /**\n         * Get dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {String}  search   Search query\n         * @param {int}     length   Number of rows per page\n         * @param {int}     start    Starting row number\n         * @param {object}  order    Sorting order\n         * @return promise           Ajax promise object\n         */\n        GET_DROPPING_OFF_STUDENTS: function(courseid, search, length, start, order) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_get_dropping_off_students',\n                args: {\n                    courseid: courseid,\n                    search: search,\n                    length: length,\n                    start: start,\n                    order: order\n                }\n            }])[0];\n        },\n\n        /**\n         * Export dropping off students list promise\n         * @param {int}     courseid Course id\n         * @param {string}  search   search query\n         * @return promise           Ajax promise object\n         */\n        EXPORT_DROPPING_OFF_STUDENTS: function(courseid, search) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_export_dropping_off_students',\n                args: {\n                    courseid: courseid,\n                    search  : search\n                }\n            }])[0];\n        },\n        /**\n         * Send message to student using student id and ajax\n         * @param  {Number} studentid   Student id\n         * @param  {String} messagetext Message text\n         * @return {Promise}            Ajax promise\n         */\n        SEND_MESSAGE: function(studentid, messagetext) {\n            return ajax.call([{\n                methodname: 'block_remuiblck_send_message',\n                args: {\n                    studentid: studentid,\n                    messagetext: messagetext\n                }\n            }])[0];\n        }\n    };\n    $('body').on('click', SELECTORS.VIEW_REPORT, function() {\n        event.preventDefault();\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            title: $(_this).attr('title')\n        }, trigger).done(function(modal) {\n            modal.modal.addClass('modal-lg');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            }).addClass('fade');\n\n            // Show loading icon till load modal body\n            modal.setBody('<i class=\"fa fa-circle-o-notch fa-spin fa-fw\" aria-hidden=\"true\"></i>');\n\n            // Fetch body using ajax request\n            PROMISES.GET_COURSE_REPORT($(_this).data('course-id'))\n            .done(function(response) {\n                modal.setBody(response);\n                if (modal.getRoot().find(SELECTORS.STATS_CHART).length != 0) {\n                    var ctx = modal.getRoot().find(SELECTORS.STATS_CHART)[0].getContext('2d');\n                    new Chart(ctx, {\n                        type: 'doughnut',\n                        data: {\n                            labels: [\n                                M.util.get_string('studentcompleted', 'block_remuiblck'),\n                                M.util.get_string('inprogress', 'block_remuiblck'),\n                                M.util.get_string('yettostart', 'block_remuiblck')\n                            ],\n                            datasets: [{\n                                backgroundColor: [\n                                    studentcompletedcolor,\n                                    inprogresscolor,\n                                    yettostartcolor\n                                ],\n                                data: [\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('studentcompleted'),\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('inprogress'),\n                                    modal.getRoot().find(SELECTORS.STATS_CHART).data('yettostart')\n                                ]\n                            }]\n                        },\n                        options: {\n                            legend: {\n                                display: false\n                            }\n                        }\n                    });\n                }\n            })\n            .fail(Notification.exception);\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n        return;\n    }).on('click', SELECTORS.STATS_TAB, function() {\n        if ($(SELECTORS.STATS_TABLE).is('.dataTable')) {\n            return;\n        }\n        $(SELECTORS.STATS_TABLE).DataTable({\n            \"bPaginate\": true,\n            \"bServerSide\": true,\n            \"language\": {\n                \"searchPlaceholder\": M.util.get_string('searchnameemail', 'block_remuiblck'),\n                \"emptyTable\"       : M.util.get_string('nostudentsenrolled', 'block_remuiblck')\n            },\n            \"dom\": '<\"wdm-export-buttons\">frtip',\n            \"initComplete\": function(settings, json) {\n                $(SELECTORS.EXPORT_WRAPPER).append(\n                    \"<button class='wdm-manage-course-export-csv btn btn-primary' data-course-id='\" + $(this).data('course-id') + \"'>\" + M.util.get_string(\n                        'exportcsv',\n                        'block_remuiblck'\n                    ) + \"</button>\"\n                );\n            },\n            \"ajax\": function(data, callback, settings) {\n                PROMISES.GET_DROPPING_OFF_STUDENTS(\n                    $(this).data('course-id'),\n                    data.search.value,\n                    data.length,\n                    data.start,\n                    data.order[0]\n                ).done(function(response) {\n                    callback(response);\n                }).fail(Notification.exception);\n            },\n            \"columns\": [\n                { \"className\": \"pb-0 pt-0\", \"data\": \"name\" },\n                { \"className\": \"pb-0 pt-0\", \"data\": \"email\" },\n                { \"className\": \"pb-0 pt-0\", \"data\": \"enroltimestart\" },\n                { \"className\": \"pb-0 pt-0\", \"data\": \"lastaccess\" }\n            ],\n            \"rowCallback\": function( row, data, index ) {\n                if(index%2 == 0){\n                    $(row).addClass('bg-grey-100');\n                }else{\n                    $(row).addClass('bg-grey-200');\n                }\n            }\n        });\n    }).on('click', SELECTORS.EXPORT, function() {\n        var _this = this;\n        PROMISES.EXPORT_DROPPING_OFF_STUDENTS(\n            $(_this).data('course-id'),\n            $(SELECTORS.STATS_FILTER_INPUT).val()\n        ).done(function(response) {\n            var file = $('<a></a>');\n            $('body').append(file);\n            $(file).attr('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(response.filedata));\n            $(file).attr('download', response.filename).hide()[0].click();\n            $(file).remove();\n        }).fail(Notification.exception);\n    }).on('click', SELECTORS.DROPPING_STUDENT_MESSAGE, function() {\n        var _this = this;\n        var trigger = $('#create-modal');\n        ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: M.util.get_string('sendmessage', 'core_message')\n        }, trigger).done(function(modal) {\n\n            // Set button text as send\n            modal.setSaveButtonText(M.util.get_string('send', 'core_message'));\n\n            // Add textarea field in body\n\n            modal.setBody('<label>'+M.util.get_string('sendmessageto', 'core_message', $($(_this).parent('td').siblings()[0]).html())+'</label><textarea class=\"form-control message\" rows=\"5\" autocomplete=\"off\"></textarea>');\n\n            // Destroy when hidden.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.destroy();\n            });\n\n            // Send message when save button is clicked\n            modal.getRoot().on(ModalEvents.save, function(event) {\n                var studentid = $(_this).data('student-id');\n                var message = $(this).find('.message').val();\n                if (message != '') {\n                    PROMISES.SEND_MESSAGE(studentid, message)\n                    .done(function(response) {\n                        modal.destroy();\n                    })\n                    .fail(function(ex) {\n                        Notification.exception(ex);\n                    });\n                }\n            }).addClass('modal-success fade');\n            modal.modal.addClass('modal-center');\n\n            // Show modal\n            setTimeout(modal.show(), 100);\n        });\n    });\n\n    var init = function(root) {\n        $(document).ready(function() {\n            ManageCoursesView.init(root);\n            ManageCoursesFilters.init(root);\n        });\n    };\n    return {\n        init: init\n    };\n});\n"],"file":"manage_courses.min.js"}