"use strict";define(["jquery","core/ajax"],function(e,t){e.feedback=function(a){var c=e.extend({ajaxURL:"",postBrowserInfo:!0,postHTML:!0,postURL:!0,proxy:void 0,letterRendering:!1,initButtonText:"Send feedback",strokeStyle:"black",shadowColor:"black",shadowOffsetX:1,shadowOffsetY:1,shadowBlur:10,lineJoin:"bevel",lineWidth:3,html2canvasURL:"html2canvas.js",feedbackButton:".feedback-btn",showDescriptionModal:!0,isDraggable:!0,onScreenshotTaken:function(){},tpl:{description:'<div id="feedback-welcome"><div class="feedback-logo">Feedback</div><p>Feedback lets you send us suggestions about our products. We welcome problem reports, feature ideas and general comments.</p><p>Start by writing a brief description:</p><textarea id="feedback-note-tmp"></textarea><p>Next we\'ll let you identify areas of the page related to your description.</p><button id="feedback-welcome-next" class="feedback-next-btn feedback-btn-gray">Next</button><div id="feedback-welcome-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',highlighter:'<div id="feedback-highlighter"><div class="feedback-logo">Feedback</div><p>Click and drag on the page to help us better understand your feedback. You can move this dialog if it\'s in the way.</p><button class="feedback-sethighlight feedback-active"><div class="ico"></div><span>Highlight</span></button><label>Highlight areas relevant to your feedback.</label><button class="feedback-setblackout"><div class="ico"></div><span>Black out</span></button><label class="lower">Black out any personal information.</label><div class="feedback-buttons"><button id="feedback-highlighter-next" class="feedback-next-btn feedback-btn-gray">Next</button><button id="feedback-highlighter-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div class="feedback-wizard-close"></div></div>',overview:'<div id="feedback-overview"><div class="feedback-logo">Feedback</div><div id="feedback-overview-description"><div id="feedback-overview-description-text"><h3>Description</h3><h3 class="feedback-additional">Additional info</h3><div id="feedback-additional-none"><span>None</span></div><div id="feedback-browser-info"><span>Browser Info</span></div><div id="feedback-page-info"><span>Page Info</span></div><div id="feedback-page-structure"><span>Page Structure</span></div></div></div><div id="feedback-overview-screenshot"><h3>Screenshot</h3></div><div class="feedback-buttons"><button id="feedback-submit" class="feedback-submit-btn feedback-btn-blue">Submit</button><button id="feedback-overview-back" class="feedback-back-btn feedback-btn-gray">Back</button></div><div id="feedback-overview-error">Please enter a description.</div><div class="feedback-wizard-close"></div></div>',submitLoading:'<div id="feedback-submit-loading"><div class="feedback-logo">Feedback</div><p>Loading...</p></div>',submitSuccess:'<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p></p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',submitError:'<div id="feedback-submit-error"><div class="feedback-logo">Feedback</div><p>Sadly an error occured while sending your feedback. Please try again.</p><button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>'},onClose:function(){},screenshotStroke:!0,highlightElement:!0,initialBox:!1},a),i=!!window.HTMLCanvasElement,d=".feedback-btn"==c.feedbackButton,s=!1;function o(){canDraw=!1,e(document).off("mouseenter.feedback mouseleave.feedback",".feedback-helper"),e(document).off("mouseup.feedback keyup.feedback"),e(document).off("mousedown.feedback",".feedback-setblackout"),e(document).off("mousedown.feedback",".feedback-sethighlight"),e(document).off("mousedown.feedback click.feedback","#feedback-close"),e(document).off("mousedown.feedback","#feedback-canvas"),e(document).off("click.feedback","#feedback-highlighter-next"),e(document).off("click.feedback","#feedback-highlighter-back"),e(document).off("click.feedback","#feedback-welcome-next"),e(document).off("click.feedback","#feedback-overview-back"),e(document).off("mouseleave.feedback","body"),e(document).off("mouseenter.feedback",".feedback-helper"),e(document).off("selectstart.feedback dragstart.feedback"),e("#feedback-module").off("click.feedback",".feedback-wizard-close,.feedback-close-btn"),e(document).off("click.feedback","#feedback-submit"),c.highlightElement&&(e(document).off("click.feedback","#feedback-canvas"),e(document).off("mousemove.feedback","#feedback-canvas")),e('[data-highlighted="true"]').removeAttr("data-highlight-id").removeAttr("data-highlighted"),e("#feedback-module").remove(),e(".feedback-btn").show(),c.onClose.call(this)}function n(t,a){a=void 0===a||a,t.clearRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),t.fillStyle="rgba(102,102,102,0.5)",t.fillRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&a&&r(t,parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&t.clearRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),e(".feedback-helper").each(function(){"blackout"==e(this).attr("data-type")&&(t.fillStyle="rgba(0,0,0,1)",t.fillRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()))})}function r(e,t,a,i,d){e.strokeStyle=c.strokeStyle,e.shadowColor=c.shadowColor,e.shadowOffsetX=c.shadowOffsetX,e.shadowOffsetY=c.shadowOffsetY,e.shadowBlur=c.shadowBlur,e.lineJoin=c.lineJoin,e.lineWidth=c.lineWidth,e.strokeRect(t,a,i,d),e.shadowOffsetX=0,e.shadowOffsetY=0,e.shadowBlur=0,e.lineWidth=1}function h(e){return!!e.match(/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/)}i&&(d&&e("body").append('<button class="feedback-btn feedback-btn-gray feedback-btn-native">'+c.initButtonText+"</button>"),e(document).on("click.feedback",c.feedbackButton,function(){d&&e(this).hide(),s||e.getScript(c.html2canvasURL,function(){s=!0});var a=!1,i="",f=e(document).height(),l=e(document).width(),b='<div id="feedback-module">';c.initialBox&&(b+=c.tpl.description),b+=c.tpl.highlighter+c.tpl.overview+'<canvas id="feedback-canvas"></canvas><div id="feedback-helpers"></div><input id="feedback-note" name="feedback-note" type="hidden"></div>',e("body").append(b),moduleStyle={position:"absolute",left:"0px",top:"0px"},canvasAttr={width:l,height:f},e("#feedback-module").css(moduleStyle),e("#feedback-canvas").attr(canvasAttr).css("z-index","30000"),c.initialBox||(e("#feedback-highlighter-back").remove(),a=!0,e("#feedback-canvas").css("cursor","crosshair"),e("#feedback-helpers").show(),e("#feedback-welcome").hide(),e("#feedback-highlighter").show()),c.isDraggable&&e("#feedback-highlighter").on("mousedown.feedback",function(t){var a=e(this).addClass("feedback-draggable"),c=a.outerHeight(),i=a.outerWidth(),d=a.offset().top+c-t.pageY,s=a.offset().left+i-t.pageX;a.css("z-index",4e4).parents().on("mousemove.feedback",function(t){_top=t.pageY+d-c,_left=t.pageX+s-i,_bottom=c-t.pageY,_right=i-t.pageX,_left<0&&(_left=0),_top<0&&(_top=0),_right>e(window).width()&&(_left=e(window).width()-i),_left>e(window).width()-i&&(_left=e(window).width()-i),_bottom>e(document).height()&&(_top=e(document).height()-c),_top>e(document).height()-c&&(_top=e(document).height()-c),e(".feedback-draggable").offset({top:_top,left:_left}).on("mouseup",function(){e(this).removeClass("feedback-draggable")})}),t.preventDefault()}).on("mouseup.feedback",function(){e(this).removeClass("feedback-draggable"),e(this).parents().off("mousemove mousedown")});var k=e("#feedback-canvas")[0].getContext("2d");if(k.fillStyle="rgba(102,102,102,0.5)",k.fillRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),rect={},drag=!1,highlight=0,post={},c.postBrowserInfo&&(post.browser={},post.browser.appCodeName=navigator.appCodeName,post.browser.appName=navigator.appName,post.browser.appVersion=navigator.appVersion,post.browser.cookieEnabled=navigator.cookieEnabled,post.browser.onLine=navigator.onLine,post.browser.platform=navigator.platform,post.browser.userAgent=navigator.userAgent,post.browser.plugins=[],e.each(navigator.plugins,function(e){post.browser.plugins.push(navigator.plugins[e].name)}),e("#feedback-browser-info").show()),c.postURL&&(post.url=document.URL,e("#feedback-page-info").show()),c.postHTML&&(post.html=e("html").html(),e("#feedback-page-structure").show()),c.postBrowserInfo||c.postURL||c.postHTML||e("#feedback-additional-none").show(),e(document).on("mousedown.feedback","#feedback-canvas",function(t){a&&(rect.startX=t.pageX-e(this).offset().left,rect.startY=t.pageY-e(this).offset().top,rect.w=0,rect.h=0,drag=!0)}),e(document).on("mouseup.feedback",function(){if(a){drag=!1;var t=rect.startY,c=rect.startX,i=rect.w,d=rect.h;if(dtype="highlight",0==i||0==d)return;i<0&&(c+=i,i*=-1),d<0&&(t+=d,d*=-1),t+d>e(document).height()&&(d=e(document).height()-t),c+i>e(document).width()&&(i=e(document).width()-c),0==highlight&&(dtype="blackout"),e("#feedback-helpers").append('<div class="feedback-helper" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+t+"px;left:"+c+"px;width:"+i+"px;height:"+d+'px;z-index:30000;"></div>'),n(k),rect.w=0}}),e(document).on("mousemove.feedback",function(t){a&&drag&&(e("#feedback-highlighter").css("cursor","default"),rect.w=t.pageX-e("#feedback-canvas").offset().left-rect.startX,rect.h=t.pageY-e("#feedback-canvas").offset().top-rect.startY,k.clearRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),k.fillStyle="rgba(102,102,102,0.5)",k.fillRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&r(k,parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),1==highlight&&(r(k,rect.startX,rect.startY,rect.w,rect.h),k.clearRect(rect.startX,rect.startY,rect.w,rect.h)),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&k.clearRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),e(".feedback-helper").each(function(){"blackout"==e(this).attr("data-type")&&(k.fillStyle="rgba(0,0,0,1)",k.fillRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()))}),0==highlight&&(k.fillStyle="rgba(0,0,0,0.5)",k.fillRect(rect.startX,rect.startY,rect.w,rect.h)))}),c.highlightElement){var p=[],g=[],u=0;e(document).on("click.feedback","#feedback-canvas",function(t){if(a){n(k),g=[],e("#feedback-canvas").css("cursor","crosshair"),e("* :not(body,script,iframe,div,section,.feedback-btn,#feedback-module *)").each(function(){"true"!==e(this).attr("data-highlighted")&&t.pageX>e(this).offset().left&&t.pageX<e(this).offset().left+e(this).width()&&t.pageY>e(this).offset().top+parseInt(e(this).css("padding-top"),10)&&t.pageY<e(this).offset().top+e(this).height()+parseInt(e(this).css("padding-top"),10)&&g.push(e(this))});var c=g[g.length-1];if(c&&!drag){e("#feedback-canvas").css("cursor","pointer");var i=c.offset().left-2,d=c.offset().top-2,s=c.width()+parseInt(c.css("padding-left"),10)+parseInt(c.css("padding-right"),10)+6,o=c.height()+parseInt(c.css("padding-top"),10)+parseInt(c.css("padding-bottom"),10)+6;1==highlight&&(r(k,i,d,s,o),k.clearRect(i,d,s,o),dtype="highlight"),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&k.clearRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),0==highlight&&(dtype="blackout",k.fillStyle="rgba(0,0,0,0.5)",k.fillRect(i,d,s,o)),e(".feedback-helper").each(function(){"blackout"==e(this).attr("data-type")&&(k.fillStyle="rgba(0,0,0,1)",k.fillRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()))}),"click"==t.type&&t.pageX==rect.startX&&t.pageY==rect.startY&&(e("#feedback-helpers").append('<div class="feedback-helper" data-highlight-id="'+u+'" data-type="'+dtype+'" data-time="'+Date.now()+'" style="position:absolute;top:'+d+"px;left:"+i+"px;width:"+s+"px;height:"+o+'px;z-index:30000;"></div>'),p.push(u),++u,n(k))}}})}e(document).on("mouseleave.feedback","body,#feedback-canvas",function(){n(k)}),e(document).on("mouseenter.feedback",".feedback-helper",function(){n(k)}),e(document).on("click.feedback","#feedback-welcome-next",function(){e("#feedback-note").val().length>0?(a=!0,e("#feedback-canvas").css("cursor","crosshair"),e("#feedback-helpers").show(),e("#feedback-welcome").hide(),e("#feedback-highlighter").show()):e("#feedback-welcome-error").show()}),e(document).on("mouseenter.feedback mouseleave.feedback",".feedback-helper",function(t){drag||(rect.w=0,rect.h=0,"mouseenter"===t.type?(e(this).css("z-index","30001"),e(this).append('<div class="feedback-helper-inner" style="width:'+(e(this).width()-2)+"px;height:"+(e(this).height()-2)+'px;position:absolute;margin:1px;"></div>'),e(this).append('<div id="feedback-close"></div>'),e(this).find("#feedback-close").css({top:e(this).find("#feedback-close").height()/2*-1+"px",left:e(this).width()-e(this).find("#feedback-close").width()/2+"px"}),"blackout"==e(this).attr("data-type")&&(k.clearRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),k.fillStyle="rgba(102,102,102,0.5)",k.fillRect(0,0,e("#feedback-canvas").width(),e("#feedback-canvas").height()),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&r(k,parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),e(".feedback-helper").each(function(){"highlight"==e(this).attr("data-type")&&k.clearRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height())}),k.clearRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()),k.fillStyle="rgba(0,0,0,0.75)",k.fillRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()),ignore=e(this).attr("data-time"),e(".feedback-helper").each(function(){if(e(this).attr("data-time")==ignore)return!0;"blackout"==e(this).attr("data-type")&&(k.fillStyle="rgba(0,0,0,1)",k.fillRect(parseInt(e(this).css("left"),10),parseInt(e(this).css("top"),10),e(this).width(),e(this).height()))}))):(e(this).css("z-index","30000"),e(this).children().remove(),"blackout"==e(this).attr("data-type")&&n(k)))}),e(document).on("click.feedback","#feedback-close",function(){if(c.highlightElement&&e(this).parent().attr("data-highlight-id"))var t=e(this).parent().attr("data-highlight-id");e(this).parent().remove(),c.highlightElement&&t&&e('[data-highlight-id="'+t+'"]').removeAttr("data-highlighted").removeAttr("data-highlight-id"),n(k)}),e("#feedback-module").on("click.feedback",".feedback-wizard-close,.feedback-close-btn",function(){o()}),e(document).on("keyup.feedback",function(e){27==e.keyCode&&o()}),e(document).on("selectstart.feedback dragstart.feedback",function(e){e.preventDefault()}),e(document).on("click.feedback","#feedback-highlighter-back",function(){a=!1,e("#feedback-canvas").css("cursor","default"),e("#feedback-helpers").hide(),e("#feedback-highlighter").hide(),e("#feedback-welcome-error").hide(),e("#feedback-welcome").show()}),e(document).on("mousedown.feedback",".feedback-sethighlight",function(){highlight=1,e(this).addClass("feedback-active"),e(".feedback-setblackout").removeClass("feedback-active")}),e(document).on("mousedown.feedback",".feedback-setblackout",function(){highlight=0,e(this).addClass("feedback-active"),e(".feedback-sethighlight").removeClass("feedback-active")}),e(document).on("click.feedback","#feedback-highlighter-next",function(){a=!1,e("#feedback-canvas").css("cursor","default");var t=e(document).scrollTop(),d=e(window).height();e("#feedback-helpers").hide(),e("#feedback-highlighter").hide(),e("#feedback-loading-icon").show(),c.screenshotStroke||n(k,!1),html2canvas(e("body"),{onrendered:function(a){c.screenshotStroke||n(k),_canvas=e('<canvas id="feedback-canvas-tmp" width="'+l+'" height="'+d+'"/>').hide().appendTo("body"),_ctx=_canvas.get(0).getContext("2d"),_ctx.drawImage(a,0,t,l,d,0,0,l,d),i=_canvas.get(0).toDataURL(),e(document).scrollTop(t),post.img=i,c.onScreenshotTaken(post.img),c.showDescriptionModal?(e("#feedback-canvas-tmp").remove(),e("#feedback-loading-icon").hide(),e("#feedback-overview").show(),e("#feedback-overview-description-text>textarea").remove(),e("#feedback-overview-screenshot>img").remove(),e('<textarea class="form-control" id="feedback-overview-note">'+e("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)"),e("#feedback-overview-screenshot").append('<img class="feedback-screenshot border-0" src="'+i+'" />')):(e("#feedback-module").remove(),o(),_canvas.remove())},proxy:c.proxy,letterRendering:c.letterRendering})}),e(document).on("click.feedback","#feedback-skiphighlighter-next",function(){a=!1,e("#feedback-canvas").css("cursor","default"),i="",post.img="",e("#feedback-helpers").hide(),e("#feedback-highlighter").hide(),e("#feedback-loading-icon").show(),e("#feedback-canvas-tmp").remove(),e("#feedback-loading-icon").hide(),e("#feedback-overview").show(),e("#feedback-overview-description-text>textarea").remove(),e("#feedback-overview-screenshot>img").remove(),e('<textarea class="form-control" id="feedback-overview-note">'+e("#feedback-note").val()+"</textarea>").insertAfter("#feedback-overview-description-text h3:eq(0)"),e("#feedback-overview-screenshot").append('<img class="feedback-screenshot border-0" src="'+M.util.image_url("no_screenshot","theme_remui")+'" />')}),e(document).on("click.feedback","#feedback-overview-back",function(t){a=!0,e("#feedback-canvas").css("cursor","crosshair"),e("#feedback-overview").hide(),e("#feedback-helpers").show(),e("#feedback-highlighter").show(),e("#feedback-overview-error").hide(),e("#feedback-email-error").hide()}),e(document).on("keyup.feedback","#feedback-note-tmp,#feedback-overview-note",function(t){var a;"feedback-note-tmp"===t.target.id?a=e("#feedback-note-tmp").val():(a=e("#feedback-overview-note").val(),e("#feedback-note-tmp").val(a)),e("#feedback-note").val(a)}),e(document).on("click.feedback","#feedback-submit",function(){if(a=!1,e("#feedback-overview-error").hide(),e("#feedback-email-error").hide(),e("#feedback-note").val().length>0&&!1!==h(e("#feedback_person_email_id_field").val())){e("#feedback-submit-success,#feedback-submit-error").remove(),e("#feedback-overview").hide(),e("#feedback-module").append(c.tpl.submitLoading),post.img=i,post.note=e("#feedback-note").val(),post.customer_email=e("#feedback_person_email_id_field").val();JSON.stringify(post);t.call([{methodname:c.ajaxURL,args:{feedbackdata:JSON.stringify(post)}}])[0].done(function(t){if(0!=t&&t>0){var a='<div id="feedback-submit-success"><div class="feedback-logo">Feedback</div><p>Thank you for your feedback. We value every piece of feedback we receive.</p>';a+="<p><b>Feedback Reference ID : "+t+" </b></p>",a+='<button class="feedback-close-btn feedback-btn-blue">OK</button><div class="feedback-wizard-close"></div></div>',e("#feedback-module").append(a)}else e("#feedback-module").append(c.tpl.submitError)}).fail(function(t){e("#feedback-module").append(c.tpl.submitError)})}else e("#feedback-note").val().length<=0&&e("#feedback-overview-error").show(),!1===h(e("#feedback_person_email_id_field").val())&&e("#feedback-email-error").show()})}))}});
//# sourceMappingURL=feedback.min.js.map
