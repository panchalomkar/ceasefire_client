"use strict";define(["jquery","core/ajax","core/notification","local_edwiserform/form_styles","local_edwiserform/iefixes","local_edwiserform/formviewer"],function(e,t,i,a){var n={CONTAINER:".edwiserform-container",FULLPAGE:"#edwiserform-fullpage",UPLOADED_FILE:"efb-uploaded-file",DELETE_FILE:"efb-delete-user-file",DELETE_CANCEL:"efb-delete-user-file-cancel",FILE:'input[type="file"]',COMPONENT:"local_edwiserform"},r={DATA_DELETING:"data-deleting",DATA_PROCESSING:"data-processing"},o={container:"",countries:"undefined"==typeof countries?null:countries,localStorage:!1},s=[],l=e(n.CONTAINER),c=e(n.FULLPAGE)&&e(n.FULLPAGE).val(),f={GET_FORM_DEFINITION:function(e){return t.call([{methodname:"edwiserform_get_form_definition",args:{form_id:e,countries:void 0===window.countries||!0}}])[0]},SUBMIT_FORM_DATA:function(e,i){return t.call([{methodname:"edwiserform_submit_form_data",args:{formid:e,data:i}}])[0]},UPLOAD_FILE:function(t){var i=new FormData;return i.append("sesskey",M.cfg.sesskey),i.append(0,t),e.ajax({url:M.cfg.wwwroot+"/local/edwiserform/upload.php",type:"POST",data:i,cache:!1,async:!1,dataType:"json",processData:!1,contentType:!1})}};function d(t,i,a,n,r,o,s){var l=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;e(a).text(r),f.SUBMIT_FORM_DATA(o,s).done(function(r){if(r.status){if(void 0!==r.data&&""!=r.data){if(data=JSON.parse(r.data),"redirect"==data.action)return void(window.location.href=data.url);if("confirmredirect"==data.action)return void(""!=r.msg?i.dom.alert("warning",r.msg,function(){window.location.href=data.url}):window.location.href=data.url)}e(t).html(r.msg),i.dom.alert("success",r.msg),null!=l&&l(t,s),e("#edwiser-activity")&&1==e("#edwiser-activity").val()&&e("body").trigger({type:"formSubmitted",cmid:e("#cmid").val()})}else""!=r.msg&&i.dom.alert("warning",r.msg),r.hasOwnProperty("errors")&&function(t,i){i=JSON.parse(i),e(".custom-validation-error").remove(),e.each(i,function(i,a){var n=e(t).find("#"+i+"-error");0==n.length&&(e(t).find('[name="'+i+'"]').after('<span id="'+i+'-error" class="text-error custom-validation-error"></span>'),n=e(t).find("#"+i+"-error")),n.text(a)})}(t,r.errors);i.dom.loadingClose(),e(a).text(n)}).fail(function(t){e(a).text(n),i.dom.loadingClose(),e(a).text(n)})}function u(t,i,a){var o=e(t).closest("form"),s=t,l=i.dom.checkValidity(o[0]),c=e(t).text(),u=e(t).attr(r.DATA_PROCESSING),m=e(o).parent().find(".id").val();if(l){if(""!=e(o).attr("action"))return e(o).submit(),!0;a.preventDefault(),i.dom.loading(),setTimeout(function(){var t=o.serializeArray();t=function(e){var t=["g-recaptcha-response"],i=[];return e.forEach(function(e,a){-1==t.indexOf(e.name)&&i.push(e)}),JSON.stringify(i)}(t=function(t,i){var a=e(t).find(n.FILE);return e.each(a,function(t,a){0!=a.files.length?f.UPLOAD_FILE(a.files[0]).done(function(t){1==t.status&&i.push({name:e(a).attr("name"),type:"file",value:t.itemid})}).fail(function(e){console.log(e)}):"true"==e(a).attr(r.DATA_DELETING)?i.push({name:e(a).attr("name"),type:"file",value:0,delete:!0}):i.push({name:e(a).attr("name"),type:"file",value:0})}),i}(o,t)),d(o,i,s,c,u,m,t)},1e3)}return!1}function m(t){o.sitekey=t,e.each(l,function(t,r){var l=e(r).parent().find(".id").val();f.GET_FORM_DEFINITION(l).done(function(i){0!=i.status?(void 0!==window.countries&&0!=window.countries||void 0===i.countries||0==i.countries||(window.countries=JSON.parse(i.countries),o.countries=countries),o.container=r,s[t]=new Formeo(o,i.definition),s[t].render(r),e(r).prepend("<h2 class='form-header'>"+i.title+"</h2>"),i.data&&function(t,i){var a=JSON.parse(i);e.each(a,function(i,a){e.each(e(t).find('[name="'+a.name+'"]'),function(t,i){switch(i.tagName){case"INPUT":switch(i.type){case"radio":i.value==a.value&&e(i).prop("checked",!0);var r=new CustomEvent("click",{target:e(i)[0]});e(i)[0].dispatchEvent(r);break;case"checkbox":i.value==a.value&&e(i).prop("checked",!0);break;case"file":0!=a.value&&(e(i).after('<span class="efb-delete-user-file-notice">'+M.util.get_string("delete-userfile-on-save-notice",n.COMPONENT)+"</span>"),e(i).after('<a href="#" class="'+n.DELETE_CANCEL+'">'+M.util.get_string("cancel-delete-userfile",n.COMPONENT)+"</a>"),e(i).after('<a href="#"  class="'+n.DELETE_FILE+'">'+M.util.get_string("efb-form-action-delete-title",n.COMPONENT)+"</a>"),e(i).after('<a class="'+n.UPLOADED_FILE+'" target="_blank" href="'+a.value+'">'+a.filename+"</a>"));break;default:e(i).val(a.value)}break;case"SELECT":if(e(i).is('[multiple="true"]')){var o=e(i).val();o.push(a.value),a.value=o}case"TEXTAREA":e(i).val(a.value)}r=new CustomEvent("change",{target:e(i)[0]}),e(i)[0].dispatchEvent(r),""!=e(i).val()&&e(i).parents(".f-field-group").addClass("active")})})}(r,i.data),a.apply(e(r).find(".formeo-render"),"add",i.style),i.action&&""!=i.action&&function(t,i){e(t).attr("action",i)}(r,i.action),e(r).submit(function(e){return u(this,s[t],e)}).find("#submit-form").click(function(){return u(this,s[t],event)})):e(r).html(i.msg).addClass("empty")}).fail(i.exception)})}return{init:function(t){e(document).ready(function(i){0!=e("#edwiserform-fullpage").length&&1==e("#edwiserform-fullpage").val()&&e("body").addClass("edwiserform-fullpage"),m(t),e(window).resize(function(){e.each(l,function(e){void 0!==s[e]&&s[e].dom.manageFormWidth(c)})}),e(".step-navigation #previous-step, .step-navigation #next-step").click(function(){}),e("body").on("click","."+n.DELETE_FILE,function(t){t.preventDefault(),e(this).siblings(n.FILE).attr(r.DATA_DELETING,!0)}).on("click","."+n.DELETE_CANCEL,function(t){t.preventDefault(),e(this).siblings(n.FILE).attr(r.DATA_DELETING,!1)}).on("change",n.FILE,function(){var t=this;if(0!=e(this)[0].files.length&&e(this).next().hasClass(n.UPLOADED_FILE)){var i=e.inArray(e(t).parents(n.CONTAINER)[0],e(n.CONTAINER));s[i].dom.multiActions("warning",M.util.get_string("attention",n.COMPONENT),M.util.get_string("user-file-replace",n.COMPONENT,e(this).find("h4").text()),[{title:M.util.get_string("proceed",n.COMPONENT),type:"warning"},{title:M.util.get_string("cancel",n.COMPONENT),type:"primary",action:function(){e(t).val("")}}])}}).on("click",".efb-view-fullpage",function(){var t=e(this).closest(n.CONTAINER).parent().find('input[class="id"]').val();window.open(M.cfg.wwwroot+"/local/edwiserform/form.php?id="+t),e(this).closest(n.CONTAINER).html(M.util.get_string("fullpage-link-clicked",n.COMPONENT))})})}}});
//# sourceMappingURL=render_form.min.js.map
