var lang_locale="",lang=document.getElementsByTagName("html")[0].getAttribute("lang");""!=lang&&"en"!=lang&&"en-us"!=lang&&(lang_locale="local_people/"+lang),define(["jquery","theme_remui/select2",lang_locale,"theme_remui/bootbox","theme_remui/notify","core/modal_factory","local_people/bootstrap-datetimepicker","core/modal_events","core/str"],function(f,e,t,a,l,n,m,o,h,p){function v(e,t,a){var n=new Date;n.setTime(n.getTime()+24*a*60*60*1e3);var o="expires="+n.toUTCString();document.cookie=e+"="+t+"; "+o}function d(e){for(var t=e+"=",a=document.cookie.split(";"),n=0;n<a.length;n++){for(var o=a[n];" "==o.charAt(0);)o=o.substring(1);if(0==o.indexOf(t))return o.substring(t.length,o.length)}return""}return{init:function(c){f(document).ready(function(){function n(e,t){var a=window.location.href,n=location.hash;if(0<=(a=a.replace(n,"")).indexOf(e+"=")){var o=a.substring(0,a.indexOf(e)),i=a.substring(a.indexOf(e));a=o+e+"="+t+(i=0<=(i=i.substring(i.indexOf("=")+1)).indexOf("&")?i.substring(i.indexOf("&")):"")}else a.indexOf("?")<0?a+="?"+e+"="+t:a+="&"+e+"="+t;return a+n}function r(e,t){var a=t.currentTarget.id,n=f(e).closest(".filterslist");"reset-form"==a&&(n=f(e).closest("#SearchParameters")),f(".reset",n).remove(),f(".filter-true",n).remove(),f("input[type=text], textarea",n).val(""),f("select",n).val("").trigger("select2:updated"),f("form[id^='form-'] .date input",n).val(""),f("small.help-block",n).hide(),f("form[id^='form-'] input[name^='never']",n).removeAttr("checked"),f("form[id^='form-'] input[name^='never']",n).closest("label").removeClass("active"),f("form[id^='form-'] input[name^='confirmed']",n).removeAttr("checked"),f("form[id^='form-'] input[name^='unconfirmed']",n).removeAttr("checked"),f("form[id^='form-'] input[name^='suspended']",n).removeAttr("checked"),f("form[id^='form-'] input[name^='unsuspended']",n).removeAttr("checked"),f(n).find(".has-error").removeClass("has-error"),f(n).find(".has-success").removeClass("has-success"),f(n).find(".form-control-feedback").remove()}f('.filterslist .panel-heading a[data-toggle="collapse"]').on("click",function(){f('.filterslist .panel-heading a[data-toggle="collapse"]').removeClass("active"),f(this).addClass("active")}),f("#form-suspended .form-radio").click(function(){f("#form-suspended .form-radio label").removeClass("form-radio-inactive")}),f("#form-confirmed .form-radio").click(function(){f("#form-confirmed .form-radio label").removeClass("form-radio-inactive")});f("#message_bulk_container").html();f("#btn_invite_user").click(function(e){e.preventDefault(),e.stopPropagation(),l.dialog({message:M.util.get_string("invite_message","local_people")+" "+f(".custom-search-form #txt").attr("value")+" ?",title:M.util.get_string("invite_title","local_people"),buttons:{success:{label:M.util.get_string("send_invite","local_people"),className:"btn btn-round btn-primary",callback:function(){f.post("invite_people.php",{email:f(".custom-search-form #txt").attr("value")}).done(function(e){1==jQuery.parseJSON(e).status?f.notify(M.util.get_string("invitation_sent","local_people"),{className:"success",autoHideDelay:3e3}):f.notify(M.util.get_string("invite_error","local_people"),{className:"error",autoHideDelay:3e3})})}}}})}),f("form[id^=form-]").submit(function(e){event.preventDefault(),event.stopPropagation(),o(e)}),f("#id_userperpage").change(function(){f(this).parents("form:first").submit()});var a=[];if(d("selected_bulks"))a=f.parseJSON(d("selected_bulks"));f(".chosen-people").select2(),f("#form-firstaccessd .form-checkbox").click(function(e){var t=f(this).find("input[name=neveraccess]");t.is(":checked")?t.parent().addClass("active"):t.parent().removeClass("active")}),f("#form-lastaccessed .form-checkbox").click(function(e){var t=f(this).find("input[name=neveraccess]");t.is(":checked")?t.parent().addClass("active"):t.parent().removeClass("active")}),f("#form-lastmodified .form-checkbox").click(function(e){var t=f(this).find("input[name=nevermodified]");t.is(":checked")?t.parent().addClass("active"):t.parent().removeClass("active")}),f("#menucompany").change(function(){if(window.history.pushState("object","title",n("company",this.value)),0!=f(document).find(".reset").length){var e=f(document).find("a.reset").closest(".panel").find("form"),t=e.find(".btn").attr("value"),a=e.find(".btn").attr("name");f("<input>").attr({name:a,value:t,type:"hidden"}).appendTo(e),e.get(0).submit()}else window.location.href=n("company",this.value)}),f("#accordion form").click(function(e){window.history.pushState("object","title",n("page","0"))});var t=function(e){e.preventDefault(),window.history.pushState("object","title",n("search",f("#txt").val())),window.location.href=n("search",f("#txt").val())};f("#txt").keypress(function(e){13==e.which&&t(e)}),f("#txt").on("input",function(e){""!=f.trim(f(this).val())?(f("#searchbutton i").addClass("fa-close"),f("#searchbutton").css("cursor","pointer"),f("#searchbutton").removeClass("hidden"),f("#searchbutton").addClass("d-block")):(f("#searchbutton i").removeClass("fa-close"),f("#searchbutton").removeClass("d-block"),f("#searchbutton").addClass("hidden"),f("#searchbutton").css("cursor","default"))}),f("#search-icon").click(function(e){t(e)}),f("#searchbutton").click(function(e){f("i",this).hasClass("fa-close")&&(f("#txt").val(""),f("#searchbutton i").removeClass("fa-close"),f("#searchbutton").removeClass("d-block"),f("#searchbutton").addClass("hidden"),f("#searchbutton").css("cursor","default"),function(e){var t,a,n=decodeURIComponent(window.location.search.substring(1)).split("&");for(a=0;a<n.length;a++)if((t=n[a].split("="))[0]===e)return void 0===t[1]||t[1]}("search")&&t(e))});var o=function(e){e.preventDefault(),f.each(["firstaccessd","lastaccessed","lastmodified"],function(e,t){f("#form-"+t+" .filter-true").length&&f("#form-"+t).closest(".filterslist")}),f("#form-courserole .filter-true").length;var t={},a={},n=f("form"),o=null,i=null;new Array;n.each(function(){t={},f("input, select",this).each(function(){(i=f(this).closest("form").attr("id"))&&-1<i.indexOf("form-")&&(o=f(this)[0].name,f(this).is(":checkbox")||f(this).is(":radio")?f(this).prop("checked")&&(t[o]=!!f(this).prop("checked")||""):t[o]=f(this).val())}),(i&&-1<i.indexOf("form-")||f(".filter-true",this).length)&&(a[i]=t)}),data=JSON.stringify(a),f("<form method='post'>").append(f('<input type="hidden" name="filters" id="data">').val(data)).appendTo("body").submit()};f("#send, #send-footer").click(function(e){return e.preventDefault(),e.stopPropagation(),o(e)}),f(".report-left-block-acordeon.col-md-3").keypress(function(e){"13"==e.which&&o(e)});var e=function(e){e.preventDefault();var t=f(this).closest("form"),a=f("<input>").attr("type","hidden").attr("class","filter-true").val("true");if(a.attr("name","filter-true"),f(t).append(a),function(e){if("form-courserole"==f(e).closest("form").attr("id"))return!1;var t=f(e).closest(".panel");return!(!f(".form-checkbox",t).length||!f(e).attr("name").match(/^never.*/)||null!=f(e).attr("checked"))||""==f.trim(f(e).val())}(this))r(this,e);else{var n=f(this).closest(".filterslist"),o=p.get_string("clear","local_people"),i="";f.when(o).done(function(e){f(".reset",n).remove(),i=f("<a>").attr("class","reset").text(e),f(".panel-heading h5",n).append(i),f(".reset",n).click(function(e){var t,a=function(e,t){for(var a=0,n=!1;1==e.hasClass(t)?n=!0:(a++,e.parent()&&(e=e.parent())),a<7&&0==n;);return 1==n&&e}(f(this),"filterslist");0!=a&&((t=a).find("input[type=text], textarea").val(""),t.find("select").val("").trigger("select2:updated"),t.find("form[id^='form-'] .date input").val(""),t.find("small.help-block").hide(),t.find("form[id^='form-'] input[name^='never']").removeAttr("checked"),t.find("form[id^='form-'] input[name^='never']").closest("label").removeClass("active"),t.find(".has-error").removeClass("has-error"),t.find(".has-success").removeClass("has-success"),t.find(".form-control-feedback").remove(),t.find(".form-check").removeClass("active"),t.find(".form-check input:radio").prop("checked",!1))}),f(".suspend-form .reset").click(function(e){f(".suspend-form .form-radio label").addClass("form-radio-inactive"),f(".suspend-form .filter-true").remove()}),f(".confirm-form .reset").click(function(e){f(".confirm-form .form-radio label").addClass("form-radio-inactive"),f(".confirm-form .filter-true").remove()}),f(".select-city .reset").click(function(){f(".select-city .custom-select").select2("val","All")}),f(".select-country .reset").click(function(){f(".select-country .custom-select").select2("val","All")}),f(".select-course .reset").click(function(){f(".select-course .custom-select").select2("val","All")})})}};f("form[id^='form-'] input[name^='never']").change(e),f("form[id^='form-'] input:radio").change(e),f("form[id^='form-'] input[name$='t'], form[id^='form-'] select").change(e),f("form[id^='form-'] input, form[id^='form-'] select").on("input",e),f("#reset-form").click(function(e){r(this,e),f("#send").click()}),f("a.reset",this).click(function(e){r(this,e),f("#send").click()}),f("a.reset").click(function(e){e.preventDefault()}),f("div.reset").click(function(e){e.preventDefault(),f("#send").click();var t=f(this).closest("div.btn-primary").data("name");f("#form-"+t).closest(".filterslist").find(".panel-heading .reset").click()}),f("form[id^='form-'] input[name^='never']").change(function(e){var t="#"+f(this).closest("form").attr("id");f("form[id^='form-'] .date input").val(""),f(t+" input[name^='never']").is(":checked")||(f(t).find(".has-error").removeClass("has-error"),f(t).find(".has-success").removeClass("has-success"),f(t).find(".form-control-feedback").remove())}),f("form[id^='form-'] .date input").change(function(){var e="#"+f(this).closest("form").attr("id");f(e+" input[name^='never']").removeAttr("checked"),f(e+" input[name^='never']").closest("label").removeClass("active")}),f(".btn-bulk-action").click(function(e){if("enrol_user"==f(this).attr("id"))return!1;e.preventDefault();var i=[],r=f(this).data("action");if(f("input[name^=id]:checked:enabled").each(function(){i.push(f(this).val())}),0<i.length)if(v("selected_bulks",[],1),f(this).data("showmodal")){var t=f("#modal-bulk-action"),s=M.cfg.wwwroot+"/local/people/ajax/request.php",a="",n=r,o=!0,c="",l="";f.ajax({method:"POST",url:s,data:{form:r,users:i,getter:!0},dataType:"json",async:!1}).done(function(e){a=e.form,n=e.title,e.q||(o=e.q,c=e.message)});var d=p.get_string("choose","core");f.when(d).done(function(e){e}),o?m.create({type:m.types.SAVE_CANCEL,title:n,body:a,large:!0},t).done(function(o){switch(o.show(),r){case"cohortadd":l="#frmcohortsadd #cohortlist";break;case"message":f("#message_bulk_container").appendTo(".modal-dialog .modal-body"),f(".modal-dialog .modal-body").find("form").removeClass("hidden"),f('.modal-dialog .modal-body form input[name="users"]').val(i.join(",")),l=".modal-dialog .modal-body form #id_messagebody"}o.getRoot().on(h.save,function(e){var a="error",n="";if(e.preventDefault(),0<f(l).length&&""!=f(l).val())f.ajax({method:"POST",url:s,data:{action:r,modaldata:JSON.stringify({users:i,input_value:f(l).val()}),getter:!1},dataType:"json",async:!1}).done(function(e){if(a=e.error?"":"success",f.trim(e))n=e.message;else{var t=p.get_string("success_message_users","local_people");f.when(t).done(function(e){f.notify(e,"success")})}}),f.notify(n,a);else{var t=p.get_string("warning_fields","local_people");f.when(t).done(function(e){f.notify(e,"error")})}o.hide()})}):f.notify(c,"error")}else{var u=JSON.stringify({name:r,data:i});f("<form method='post'>").append(f('<input type="hidden" name="bulk_action" id="data">').val(u)).appendTo("body").submit()}}),f(".btn-bulk-suspend_unsuspend").click(function(e){e.preventDefault();var t=[],a=f(this).data("action");if(f("input[name^=id]:checked:enabled").each(function(){t.push(f(this).val())}),0<t.length){v("selected_bulks",[],1);var n=JSON.stringify({name:"suspend_unsuspend",data:t}),o=f("<form method='post' action='"+M.cfg.wwwroot+"/local/people/actions/user_bulk_suspend_unsuspend.php'>").append(f('<input type="hidden" name="bulk_action" id="data">').val(n));o.append(f('<input type="hidden" name="'+a+'">').val(1)),o.append(f('<input type="hidden" name="sesskey">').val(M.cfg.sesskey)),o.appendTo("body").submit()}}),f("input:radio[name='unsuspended']").click(function(){this.checked=!0,f("input:radio[name='suspended']").each(function(e){this.checked=!1})}),f("input:radio[name='suspended']").click(function(){this.checked=!0,f("input:radio[name='unsuspended']").each(function(e){this.checked=!1})}),f("label[for='unconfirmed']").click(function(){this.checked=!0,f("#confirmed").each(function(e){this.checked=!1})}),f("label[for='confirmed']").click(function(){this.checked=!0,f("#unconfirmed").each(function(e){this.checked=!1})}),f("#enrol_user").click(function(e){var t=[];if(f("input[name^=id]:checked:enabled").each(function(){t.push(f(this).val())}),!(t.length<=0)){var a=f("#enrollModal");m.create({title:c.title,body:c.body,footer:c.footer},a).done(function(e){e.show();var t={icons:{time:"fa fa-clock-o",date:"fa fa-calendar",up:"fa fa-chevron-up",down:"fa fa-chevron-down",previous:"fa fa-chevron-left",next:"fa fa-chevron-right",today:"fa fa-screenshot",clear:"fa fa-trash",close:"fa fa-remove"},format:"MM/DD/YYYY"};f("#EnrolForm #selectcourses").select2({width:"50%"}),f("#EnrolForm #startdate").datetimepicker(t),f("#EnrolForm #enddate").datetimepicker(t),f("#EnrolForm #selectroles").select2({width:"50%"});var a=[];f('form#EnrolForm input[name^="id"]').remove(),f("input[name^=id]:checked:enabled").each(function(){a.push(f(this).val())}),0<a.length&&(v("selected_bulks",[],1),f.each(a,function(e,t){f("form#EnrolForm").append('<input type="hidden" name="id[]" value="'+t+'" />')})),f("button#enroll").click(function(){f("form#EnrolForm").submit()})})}}),f("#form-bulk-actions input:checkbox").eq(0).attr("value","0"),f("#bulk-select-all").click(function(){if(document.getElementById("bulk-select-all").checked)f("#form-bulk-actions input:checkbox").attr("checked","checked"),f("#form-bulk-actions input:checkbox").prop("checked",!0),f("#form-bulk-actions tbody tr").addClass("table-active"),f("#form-bulk-actions label.form-checkbox").each(function(e){-1==f.inArray(f("input",this).val(),a)&&null!=f("input",this).val()&&a.push(f("input[name^=id]:enabled",this).val())});else{f("#form-bulk-actions input:checkbox").removeAttr("checked"),f("#form-bulk-actions input:checkbox").prop("checked",!1),f("#form-bulk-actions tbody tr").removeClass("table-active");f("input[name^=id]:enabled",this).val();f("#form-bulk-actions label.form-checkbox").each(function(e){var t=f("input[name^=id]:enabled",this).val();a=f.grep(a,function(e){return e!=t})})}v("selected_bulks",JSON.stringify(a),1)}),f("#bulk-select-all").click(function(){var e=1<f('#form-bulk-actions input[checked="checked"]').length;i(e)});var i=function(a){f(["delete","download","message","cohortadd","suspend","unlock"]).each(function(e,t){a?(f('#enrol_user, a[data-action="'+t+'"]').css("opacity","1"),f('#enrol_user, a[data-action="'+t+'"]').css("cursor","pointer"),f('#enrol_user, a[data-action="'+t+'"]').addClass("active-bulk"),f('#enrol_user, a[data-action="'+t+'"]').find(".add-tooltip").tooltip("enable"),f("#enrol_user").attr("data-target","#enrollModal")):(f('#enrol_user, a[data-action="'+t+'"]').css("opacity","0.3"),f('#enrol_user, a[data-action="'+t+'"]').css("cursor","default"),f('#enrol_user, a[data-action="'+t+'"]').removeClass("active-bulk"),f('#enrol_user, a[data-action="'+t+'"]').find(".add-tooltip").tooltip("disable"),f("#enrol_user").attr("data-target",""))})};f("#form-bulk-actions input").change(function(e){var t=0<f("#form-bulk-actions input:checked").length;i(t),f(this).closest("tr").hasClass("table-active")?f(this).closest("tr").removeClass("table-active"):f(this).closest("tr").addClass("table-active")});var s=0<parseInt(f(".table-people input:checked").length);i(s),f("#form-bulk-actions .form-checkbox").change(function(e){if(f("input[name^=id]:checked:enabled",this).val())-1==f.inArray(f("input",this).val(),a)&&a.push(f("input[name^=id]:checked:enabled",this).val());else{var t=f("input[name^=id]:enabled",this).val();a=f.grep(a,function(e){return e!=t})}v("selected_bulks",JSON.stringify(a),1)}),f("#form-bulk-actions label.form-checkbox").each(function(e){-1!==f.inArray(f("input",this).val(),a)&&f(this).click()}),f("input:radio").click(function(){var e=f(this).parent();e.hasClass("active")||e.addClass("active")})})}}});