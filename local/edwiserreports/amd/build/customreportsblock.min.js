"use strict";define(["jquery","core/ajax","core/modal_factory","core/modal_events","core/templates","core/notification","core/str","local_edwiserreports/jquery.dataTables","local_edwiserreports/dataTables.bootstrap4"],function(e,t,s,o,a,r,l){var i=".field .custom-field-checkbox",n=".reports-filter-body .custom-field-select",d="#wdm-cohort-select",c="#wdm-course-select",p="#wdm-custom-reports-save",m="#wdm-customreports-save-form",u='[id^="wdm-desktopenable-"]',h='#cr-list-table a[data-action="delete"]',f='#cr-list-table a[data-action="hide"]',g=".reports-preview-header .rp-header",_=null,w=null,v=M.util.get_string("savecustomreport","local_edwiserreports"),y=[],b=[],C=[],k=0,x=!0,N={downloadenable:!0},T={selector:".reports-preview-body .reports-preview-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},S={selector:".reports-preview-body .reports-preview-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),T.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),T.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),T.hide()}},J={selector:".reports-list-body .reports-list-content.loader",show:function(){e(this.selector).removeClass("d-none").addClass("d-flex")},hide:function(){e(this.selector).removeClass("d-flex").addClass("d-none")}},O={selector:".reports-list-body .reports-list-content",show:function(){e(this.selector+":not(.loader)").removeClass("d-none").addClass("d-flex"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),J.hide()},hide:function(){e(this.selector+":not(.loader)").removeClass("d-flex").addClass("d-none"),e(this.selector+".empty").removeClass("d-flex").addClass("d-none"),J.show()},empty:function(){e(this.selector+".empty").removeClass("d-none").addClass("d-flex"),e(this.selector+":not(.empty)").removeClass("d-flex").addClass("d-none"),J.hide()}};function D(){if(x){x=!1,y=[],C=e(d).val(),b=e(c).val(),e(i+":checked").each(function(){y.push(e(this).val())});var s=t.call([{methodname:"local_edwiserreports_get_customreports_data",args:{params:JSON.stringify({fields:y,cohorts:C,courses:b})}}]);0==y.length?(S.empty(),e(p).prop("disabled",!0),x=!0):(S.hide(),s[0].done(function(t){if(t.success){var s=JSON.parse(t.data);0==s.reportsdata.length?(S.empty(),e(p).prop("disabled",!0)):(_&&(_.clear().destroy(),e("#cr-preview-table").html("")),S.show(),_=e("#cr-preview-table").DataTable({columns:s.columns,data:s.reportsdata,bInfo:!1,bFilter:!1,searching:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}}),e(p).prop("disabled",!1))}}).always(function(){x=!0}))}}function q(){s.create({title:v,type:s.types.SAVE_CANCEL,body:a.render("local_edwiserreports/custom_reports_save_form",N)}).done(function(t){var s=t.getRoot();s.find(".modal-dialog").addClass("modal-lg"),t.show(),s.on(o.save,function(o){o.preventDefault(),s.find("input").on("input",function(){e('[id^="id_error_crb"]').html("")});var a=e(m).serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{});(function(t){var s=!0;return""==t.reportname&&(e("#id_error_crb_reportname").html(M.util.get_string("emptyfullname","local_edwiserreports")).show(),s=!1),""==t.reportshortname&&(e("#id_error_crb_reportshortname").html(M.util.get_string("emptyshortname","local_edwiserreports")).show(),s=!1),/[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/.test(t.reportshortname)&&(e("#id_error_crb_reportshortname").html(M.util.get_string("nospecialchar","local_edwiserreports")).show(),s=!1),s})(a)&&(a.querydata={selectedfield:y,cohorts:C,courses:b},j(a,t))})})}function j(s,o){t.call([{methodname:"local_edwiserreports_save_customreports_data",args:{params:JSON.stringify(s)}}])[0].done(function(t){t.success?(o&&(N=JSON.parse(t.reportsdata),e(g).html(N.reportname),e(p).html(M.util.get_string("updatereports","local_edwiserreports"))),e("#user-notifications .close").click(),r.addNotification({message:M.util.get_string("reportssavesuccess","local_edwiserreports"),type:"success"})):(e("#user-notifications .close").click(),r.addNotification({message:t.errormsg,type:"error"})),o&&(e("html, body").animate({scrollTop:0},"slow"),A(),o.hide(),o.destroy())})}function A(){t.call([{methodname:"local_edwiserreports_get_customreports_list",args:{params:JSON.stringify({})}}])[0].done(function(t){var s=JSON.parse(t.data);t.success&&(0==s.length?O.empty():(w&&(w.clear().destroy(),e("#cr-list-table").html("")),w=e("#cr-list-table").DataTable({columns:[{data:"fullname",title:M.util.get_string("title","local_edwiserreports")},{data:"createdby",title:M.util.get_string("createdby","local_edwiserreports")},{data:"datecreated",title:M.util.get_string("datecreated","local_edwiserreports")},{data:"datemodified",title:M.util.get_string("datemodified","local_edwiserreports")},{data:"managehtml",title:M.util.get_string("manage","local_edwiserreports")}],language:{searchPlaceholder:M.util.get_string("searchreports","local_edwiserreports"),emptyTable:M.util.get_string("noresult","local_edwiserreports")},order:[[0,"asc"]],data:s,bInfo:!1,lengthChange:!1,drawCallback:function(){e(".dataTables_paginate > .pagination").addClass("pagination-sm pull-right"),e(".dataTables_filter").addClass("pagination-sm pull-right")}}),O.show()))})}function E(){e(i).on("change",function(){D()}),e(n).on("change",function(){D()}),e(p).on("click",function(){q()}),A(),e(document).on("change",u,function(){var t=!1;e(this).is(":checked")&&(t=!0),j({reportsid:e(this).data("reportsid"),enabledesktop:t,action:"enabledesktop"},!1)}),e(document).on("click",h,function(s){s.preventDefault();var o=e(this).data("reportsid");l.get_strings([{key:"deletecustomreportstitle",component:"local_edwiserreports"},{key:"deletecustomreportsquestion",component:"local_edwiserreports"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(a){r.confirm(a[0],a[1],a[2],a[3],e.proxy(function(){var s;s=o,t.call([{methodname:"local_edwiserreports_delete_custom_report",args:{params:JSON.stringify({reportsid:s})}}])[0].done(function(e){e.success?r.addNotification({message:e.message,type:"success"}):r.addNotification({message:e.message,type:"error"})}).always(function(){e("html, body").animate({scrollTop:0},"slow"),A()})},s.currentTarget))})}),e(document).on("click",f,function(t){t.preventDefault();var s=e(this).data("target");e(this).data("value")?(e(this).attr("title",e(this).data("titlehide")),e(this).attr("data-original-title",e(this).data("titlehide")),e(this).data("value",0)):(e(this).attr("title",e(this).data("titleshow")),e(this).attr("data-original-title",e(this).data("titleshow")),e(this).data("value",1)),e(this).find(".icon").toggleClass("fa-eye"),e(this).find(".icon").toggleClass("fa-eye-slash"),e(s).trigger("click")})}return{init:function(){e(document).ready(function(){E(),0!==(k=e("#wdm_custom_reports_id").val())&&(N.reportsid=k,N.reportname=e("#wdm_custom_reports_fullname").val(),N.reportshortname=e("#wdm_custom_reports_shortname").val(),0!=e("#wdm_custom_reports_downloadenable").val()?N.downloadenable=!0:N.downloadenable=!1,0!=e("#wdm_custom_reports_desktopenable").val()?N.enabledesktop=!0:N.enabledesktop=!1,D())})}}});
//# sourceMappingURL=customreportsblock.min.js.map
