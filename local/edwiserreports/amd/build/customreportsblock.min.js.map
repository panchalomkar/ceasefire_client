{"version":3,"sources":["customreportsblock.js"],"names":["define","$","ajax","modalFactory","modalEvents","templates","notif","str","cfCheckbox","cfSelect","cfCohort","cfCourse","cfSave","cfSaveForm","crDesktopEnableSwitch","crDeleteBtn","crHideBtn","cpHeader","cfPreviewTable","crListTable","customReportSaveTitle","M","util","get_string","selectedFields","courses","cohorts","reportsId","reportsDataLoaded","reportsData","downloadenable","cfPreviewLoader","selector","show","this","removeClass","addClass","hide","cfPreview","empty","crListLoader","crList","getCustomReportsData","val","each","push","getCustomReportsDataAjax","call","methodname","args","params","JSON","stringify","fields","length","prop","done","response","success","data","parse","reportsdata","clear","destroy","html","DataTable","columns","bInfo","bFilter","searching","lengthChange","drawCallback","always","saveCustomReportsData","create","title","type","types","SAVE_CANCEL","body","render","modal","root","getRoot","find","on","save","e","preventDefault","serializeArray","reduce","obj","item","name","value","ret","reportname","reportshortname","test","validateCustomReprtsSaveData","querydata","selectedfield","saveCustomReportsDataService","click","addNotification","message","errormsg","animate","scrollTop","getCustomReportsList","language","searchPlaceholder","emptyTable","order","customReportServiceInit","document","enabledesktop","is","reportsid","action","reportId","get_strings","key","component","s","confirm","proxy","currentTarget","checkboxId","attr","toggleClass","trigger","init","ready"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/**\n * Plugin administration pages are defined here.\n *\n * @package     local_edwiserreports\n * @copyright   2021 wisdmlabs <support@wisdmlabs.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'core/notification',\n    'core/str',\n    'local_edwiserreports/jquery.dataTables',\n    'local_edwiserreports/dataTables.bootstrap4'\n], function(\n    $,\n    ajax,\n    modalFactory,\n    modalEvents,\n    templates,\n    notif,\n    str\n) {\n    'use strict';\n\n    // Field group checkbox\n    var cfCheckbox = '.field .custom-field-checkbox';\n    var cfSelect = '.reports-filter-body .custom-field-select';\n    var cfCohort = '#wdm-cohort-select';\n    var cfCourse = '#wdm-course-select';\n    var cfSave = '#wdm-custom-reports-save';\n    var cfSaveForm = '#wdm-customreports-save-form';\n    var crPageId = '#wdm_custom_reports_id';\n    var crPageFullname = '#wdm_custom_reports_fullname';\n    var crPageShortname = '#wdm_custom_reports_shortname';\n    var crPageDownloadEnable = '#wdm_custom_reports_downloadenable';\n    var crPageDesktopEnable = '#wdm_custom_reports_desktopenable';\n    var crDesktopEnableSwitch = '[id^=\"wdm-desktopenable-\"]';\n    var crDeleteBtn = '#cr-list-table a[data-action=\"delete\"]';\n    var crHideBtn = '#cr-list-table a[data-action=\"hide\"]';\n    var cpHeader = '.reports-preview-header .rp-header';\n    var cfPreviewTable = null;\n    var crListTable = null;\n    var customReportSaveTitle = M.util.get_string('savecustomreport', 'local_edwiserreports');\n\n    var selectedFields = [];\n    var courses = [];\n    var cohorts = [];\n    var reportsId = 0;\n    var reportsDataLoaded = true;\n    var reportsData = {\n        downloadenable: true\n    };\n\n    var cfPreviewLoader = {\n        selector: '.reports-preview-body .reports-preview-content.loader',\n\n        show: function() {\n            $(this.selector).removeClass('d-none').addClass('d-flex');\n        },\n\n        hide: function() {\n            $(this.selector).removeClass('d-flex').addClass('d-none');\n        }\n    };\n\n    var cfPreview = {\n        selector: '.reports-preview-body .reports-preview-content',\n\n        show: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-none').addClass('d-flex');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        },\n\n        hide: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-flex').addClass('d-none');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.show();\n        },\n\n        empty: function() {\n            $(this.selector + '.empty').removeClass('d-none').addClass('d-flex');\n            $(this.selector + ':not(.empty)').removeClass('d-flex').addClass('d-none');\n            cfPreviewLoader.hide();\n        }\n    };\n\n    var crListLoader = {\n        selector: '.reports-list-body .reports-list-content.loader',\n\n        show: function() {\n            $(this.selector).removeClass('d-none').addClass('d-flex');\n        },\n\n        hide: function() {\n            $(this.selector).removeClass('d-flex').addClass('d-none');\n        }\n    };\n\n    var crList = {\n        selector: '.reports-list-body .reports-list-content',\n\n        show: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-none').addClass('d-flex');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            crListLoader.hide();\n        },\n\n        hide: function() {\n            $(this.selector + ':not(.loader)').removeClass('d-flex').addClass('d-none');\n            $(this.selector + '.empty').removeClass('d-flex').addClass('d-none');\n            crListLoader.show();\n        },\n\n        empty: function() {\n            $(this.selector + '.empty').removeClass('d-none').addClass('d-flex');\n            $(this.selector + ':not(.empty)').removeClass('d-flex').addClass('d-none');\n            crListLoader.hide();\n        }\n    };\n\n    /**\n     * Get custum reports data.\n     */\n    function getCustomReportsData() {\n        if (reportsDataLoaded) {\n            reportsDataLoaded = false;\n            selectedFields = [];\n            cohorts = $(cfCohort).val();\n            courses = $(cfCourse).val();\n            $(cfCheckbox + \":checked\").each(function() {\n                selectedFields.push($(this).val());\n            });\n\n            var getCustomReportsDataAjax = ajax.call([{\n                methodname: 'local_edwiserreports_get_customreports_data',\n                args: {\n                    params: JSON.stringify({\n                        fields: selectedFields,\n                        cohorts: cohorts,\n                        courses: courses\n                    })\n                }\n            }]);\n\n            if (selectedFields.length == 0) {\n                cfPreview.empty();\n                $(cfSave).prop('disabled', true);\n                reportsDataLoaded = true;\n            } else {\n                cfPreview.hide();\n                getCustomReportsDataAjax[0].done(function(response) {\n                    if (response.success) {\n                        var data = JSON.parse(response.data);\n                        if (data.reportsdata.length == 0) {\n                            cfPreview.empty();\n                            $(cfSave).prop('disabled', true);\n                        } else {\n                            if (cfPreviewTable) {\n                                cfPreviewTable.clear().destroy();\n                                $('#cr-preview-table').html('');\n                            }\n                            cfPreview.show();\n                            cfPreviewTable = $('#cr-preview-table').DataTable({\n                                columns: data.columns,\n                                data: data.reportsdata,\n                                bInfo: false,\n                                bFilter: false,\n                                searching: false,\n                                lengthChange: false,\n                                drawCallback: function() {\n                                    $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');\n                                    $('.dataTables_filter').addClass('pagination-sm pull-right');\n                                }\n                            });\n                            $(cfSave).prop('disabled', false);\n                        }\n                    }\n                }).always(function() {\n                    reportsDataLoaded = true;\n                });\n            }\n        }\n    }\n\n    /**\n     * Validate custom reports data to save.\n     * @param {Object} data Custom report data object\n     * @return {Boolean}\n     */\n    function validateCustomReprtsSaveData(data) {\n        var ret = true;\n        if (data.reportname == '') {\n            $('#id_error_crb_reportname')\n                .html(M.util.get_string('emptyfullname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        if (data.reportshortname == '') {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('emptyshortname', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n\n        // eslint-disable-next-line no-useless-escape\n        var format = /[ `!@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?~]/;\n        if (format.test(data.reportshortname)) {\n            $('#id_error_crb_reportshortname')\n                .html(M.util.get_string('nospecialchar', 'local_edwiserreports'))\n                .show();\n            ret = false;\n        }\n        return ret;\n    }\n\n    /**\n     * Save custom reports data confirmation module.\n     */\n    function saveCustomReportsData() {\n        modalFactory.create({\n            title: customReportSaveTitle,\n            type: modalFactory.types.SAVE_CANCEL,\n            body: templates.render('local_edwiserreports/custom_reports_save_form', reportsData)\n        }).done(function(modal) {\n            var root = modal.getRoot();\n            root.find('.modal-dialog').addClass('modal-lg');\n            modal.show();\n            root.on(modalEvents.save, function(e) {\n                // Stop the default save button behaviour which is to close the modal.\n                e.preventDefault();\n\n                // Remove all error on type\n                root.find('input').on('input', function() {\n                    $('[id^=\"id_error_crb\"]').html('');\n                });\n\n                var data = $(cfSaveForm).serializeArray().reduce(function(obj, item) {\n                    obj[item.name] = item.value;\n                    return obj;\n                }, {});\n\n                if (validateCustomReprtsSaveData(data)) {\n                    // Prepare query data\n                    data.querydata = {\n                        'selectedfield': selectedFields,\n                        'cohorts': cohorts,\n                        'courses': courses\n                    };\n\n                    saveCustomReportsDataService(data, modal);\n                }\n            });\n        });\n    }\n\n    /**\n     * Save customo report data to database.\n     * @param {Object} data Custom report data\n     * @param {Moodle_Factory} modal Modal object\n     */\n    function saveCustomReportsDataService(data, modal) {\n        var saveCustomReportsData = ajax.call([{\n            methodname: 'local_edwiserreports_save_customreports_data',\n            args: {\n                params: JSON.stringify(data)\n            }\n        }]);\n\n        saveCustomReportsData[0].done(function(response) {\n            if (response.success) {\n                if (modal) {\n                    reportsData = JSON.parse(response.reportsdata);\n                    $(cpHeader).html(reportsData.reportname);\n                    $(cfSave).html(M.util.get_string('updatereports', 'local_edwiserreports'));\n                }\n                $('#user-notifications .close').click();\n                notif.addNotification({\n                    message: M.util.get_string('reportssavesuccess', 'local_edwiserreports'),\n                    type: \"success\"\n                });\n            } else {\n                $('#user-notifications .close').click();\n                notif.addNotification({\n                    message: response.errormsg,\n                    type: \"error\"\n                });\n            }\n            if (modal) {\n                $(\"html, body\").animate({scrollTop: 0}, \"slow\");\n                getCustomReportsList();\n                modal.hide();\n                modal.destroy();\n            }\n        });\n    }\n\n    /**\n     * Get reports list of custom reports.\n     */\n    function getCustomReportsList() {\n        var getCustomReportsList = ajax.call([{\n            methodname: 'local_edwiserreports_get_customreports_list',\n            args: {\n                params: JSON.stringify({})\n            }\n        }]);\n        getCustomReportsList[0].done(function(response) {\n            var data = JSON.parse(response.data);\n            if (response.success) {\n                if (data.length == 0) {\n                    crList.empty();\n                } else {\n                    if (crListTable) {\n                        crListTable.clear().destroy();\n                        $('#cr-list-table').html('');\n                    }\n\n                    crListTable = $('#cr-list-table').DataTable({\n                        columns: [\n                            {\n                                data: 'fullname',\n                                title: M.util.get_string('title', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'createdby',\n                                title: M.util.get_string('createdby', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'datecreated',\n                                title: M.util.get_string('datecreated', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'datemodified',\n                                title: M.util.get_string('datemodified', 'local_edwiserreports')\n                            },\n                            {\n                                data: 'managehtml',\n                                title: M.util.get_string('manage', 'local_edwiserreports')\n                            }\n                        ],\n                        language: {\n                            searchPlaceholder: M.util.get_string('searchreports', 'local_edwiserreports'),\n                            emptyTable: M.util.get_string('noresult', 'local_edwiserreports')\n                        },\n                        order: [[0, 'asc']],\n                        data: data,\n                        bInfo: false,\n                        lengthChange: false,\n                        drawCallback: function() {\n                            $('.dataTables_paginate > .pagination').addClass('pagination-sm pull-right');\n                            $('.dataTables_filter').addClass('pagination-sm pull-right');\n                        }\n                    });\n                    crList.show();\n                }\n            }\n        });\n    }\n\n    /**\n     * Delete custom reports data.\n     * @param {Integer} reportsId Report id\n     */\n    function customReportDelete(reportsId) {\n        var deleteCustomReport = ajax.call([{\n            methodname: 'local_edwiserreports_delete_custom_report',\n            args: {\n                params: JSON.stringify({reportsid: reportsId})\n            }\n        }]);\n        deleteCustomReport[0].done(function(response) {\n            if (response.success) {\n                notif.addNotification({\n                    message: response.message,\n                    type: \"success\"\n                });\n            } else {\n                notif.addNotification({\n                    message: response.message,\n                    type: \"error\"\n                });\n            }\n        }).always(function() {\n            $(\"html, body\").animate({scrollTop: 0}, \"slow\");\n            getCustomReportsList();\n        });\n    }\n\n    /**\n     * Initialise custom reports events.\n     */\n    function customReportServiceInit() {\n        $(cfCheckbox).on('change', function() {\n            getCustomReportsData();\n        });\n        $(cfSelect).on('change', function() {\n            getCustomReportsData();\n        });\n        $(cfSave).on('click', function() {\n            saveCustomReportsData();\n        });\n        getCustomReportsList();\n        $(document).on('change', crDesktopEnableSwitch, function() {\n            var enabledesktop = false;\n            if ($(this).is(\":checked\")) {\n                enabledesktop = true;\n            }\n            var updateData = {\n                reportsid: $(this).data('reportsid'),\n                enabledesktop: enabledesktop,\n                action: 'enabledesktop'\n            };\n\n            saveCustomReportsDataService(updateData, false);\n        });\n        $(document).on('click', crDeleteBtn, function(e) {\n            e.preventDefault();\n\n            var reportId = $(this).data('reportsid');\n            str.get_strings([\n                {\n                    key: 'deletecustomreportstitle',\n                    component: 'local_edwiserreports'\n                },\n                {\n                    key: 'deletecustomreportsquestion',\n                    component: 'local_edwiserreports'\n                },\n                {\n                    key: 'yes',\n                    component: 'moodle'\n                },\n                {\n                    key: 'no',\n                    component: 'moodle'\n                }\n            ]).done(function(s) {\n                notif.confirm(s[0], s[1], s[2], s[3], $.proxy(function() {\n                    customReportDelete(reportId);\n                }, e.currentTarget));\n            });\n        });\n        $(document).on('click', crHideBtn, function(e) {\n            e.preventDefault();\n\n            var checkboxId = $(this).data('target');\n            if ($(this).data('value')) {\n                $(this).attr('title', $(this).data('titlehide'));\n                $(this).attr('data-original-title', $(this).data('titlehide'));\n                $(this).data('value', 0);\n            } else {\n                $(this).attr('title', $(this).data('titleshow'));\n                $(this).attr('data-original-title', $(this).data('titleshow'));\n                $(this).data('value', 1);\n            }\n            $(this).find('.icon').toggleClass('fa-eye');\n            $(this).find('.icon').toggleClass('fa-eye-slash');\n            $(checkboxId).trigger('click');\n        });\n    }\n\n    return {\n        init: function() {\n            $(document).ready(function() {\n                customReportServiceInit();\n                reportsId = $(crPageId).val();\n                if (reportsId !== 0) {\n                    reportsData.reportsid = reportsId;\n                    reportsData.reportname = $(crPageFullname).val();\n                    reportsData.reportshortname = $(crPageShortname).val();\n\n                    if ($(crPageDownloadEnable).val() != 0) {\n                        reportsData.downloadenable = true;\n                    } else {\n                        reportsData.downloadenable = false;\n                    }\n\n                    if ($(crPageDesktopEnable).val() != 0) {\n                        reportsData.enabledesktop = true;\n                    } else {\n                        reportsData.enabledesktop = false;\n                    }\n\n                    getCustomReportsData();\n                }\n            });\n        }\n    };\n});\n"],"file":"customreportsblock.min.js"}